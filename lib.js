!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.GoResultsHighlighter=t():e.GoResultsHighlighter=t()}(this,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>T});const n={prefixCls:"go-results-",rearrangedCls:"rearranged",tableCls:"table",gameCls:"game",currentCls:"current",results:{won:"([0-9]+)\\+",lost:"([0-9]+)\\-",jigo:"([0-9]+)=",unresolved:"([0-9]+)\\?"},startingRow:0,placeColumn:null,roundsColumns:null,rowTags:"tr",cellTags:"td",ignoreOutOfBoundsRows:!1,checkColumnsForResults:!0,cellSeparator:"[\t ]+",joinNames:!0,hovering:!0,rearranging:!0},s=["rearrangedCls","tableCls","gameCls","currentCls"],r={RESULT_TABLE:"data-go-results",SETTING_STARTING_ROW:"data-go-starting-row",SETTING_PLACE_COLUMN:"data-go-place-column",SETTING_ROUNDS_COLUMNS:"data-go-rounds-columns",SETTING_REARRANGING:"data-go-rearranging",SETTING_HOVERING:"data-go-hovering",PLAYER_PLACEMENT:"data-go-place",OPPONENT_PLACEMENT:"data-go-opponent",OPPONENTS:"data-go-opponents",GAME_RESULT:"data-go-result"};function i(e){const t=[];for(let n in e)e.hasOwnProperty(n)&&t.push({cls:n,regexp:new RegExp(e[n])});return t}function l(e){return Array.prototype.slice.call(e)}function o(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];const r=n.filter((e=>"object"==typeof e)).reverse(),i=r.length,l={};e:for(let t in e){for(let e=0;e<i;e++)if(r[e].hasOwnProperty(t)){l[t]=r[e][t];continue e}l[t]=e[t]}return l}const a=.4;function g(e,t){e.setAttribute(r.PLAYER_PLACEMENT,t)}function h(e){const t=[];for(let n=0;n<e.length;n++)for(let s=0;s<e[n].cells.length;s++)t[s]||(t[s]=[]),t[s][n]=e[n].cells[s].textContent;return t}function u(e){const t=Number(e);return!isNaN(t)&&t>0}function c(e){return e&&String(e).length>0}function p(e){return(t,n)=>-1!==e.indexOf(n)}function m(e,t){const s=o(n,t),m=i(s.results),f=m.length,d=function(e,t){const n=e.querySelectorAll(t.rowTags),s=new Array(n.length);for(let e=0;e<n.length;e++){const r=n[e],i=r.querySelectorAll(t.cellTags);s[e]={row:r,cells:l(i)}}return s}(e,s),E=function(e,t,n){return"string"==typeof t.roundsColumns?p(t.roundsColumns.split(",").map(Number)):t.checkColumnsForResults?p(function(e,t){return h(e).reduce(((e,n,s)=>(function(e,t){const n=e.filter(c).length,s=function(e,t){return e.filter((e=>t.some((t=>e.match(t.regexp)))))}(e,t).length;return s/n>=a}(n,t)&&e.push(s),e)),[])}(e,n)):()=>!0}(d,s,m),N=function(e,t){if("number"==typeof t.placeColumn)return t.placeColumn;const n=h(e).findIndex((e=>{const t=e.filter(c).length;return e.filter(u).length/t>=a}));return Math.max(n,0)}(d,s),C={};let T,A;return d.forEach((function(e,t){let{row:n,cells:i}=e;if(t<s.startingRow)return;let l=-1;if(!i.length||!i[N])return void g(n,l);let o=parseInt(i[N].textContent,10);const a={tournamentPlace:-1,row:n,games:[],opponents:[],opponentsCls:{}};if(n.hasAttribute(r.PLAYER_PLACEMENT))l=Number(n.getAttribute(r.PLAYER_PLACEMENT));else{if(A)l=A+1;else{if(isNaN(o))return void g(n,l);l=o||1}o?o<=T&&(o=T):o=T||1,g(n,l)}-1!==Number(l)&&(a.gridPlacement=l,a.tournamentPlace=o,i.forEach(((e,t)=>{E(e,t)&&function(e,t,n){let i,l;if(t.hasAttribute(r.GAME_RESULT)&&t.hasAttribute(r.OPPONENT_PLACEMENT))i=Number(t.getAttribute(r.OPPONENT_PLACEMENT)),l=t.getAttribute(r.GAME_RESULT);else{for(let e=0;e<f;e++){let n=t.textContent.match(m[e].regexp);if(n){if(i=Number(n[1]),l=m[e].cls,i<=0||!s.ignoreOutOfBoundsRows&&i>d.length)return;t.setAttribute(r.OPPONENT_PLACEMENT,i),t.setAttribute(r.GAME_RESULT,m[e].cls)}}if(!i)return}t.highlighterGame={player:e.gridPlacement,opponent:i,row:e.row,column:n},e.games.push({cell:t,index:n,opponentPlace:i,cls:l}),e.opponentsCls[i]=l,e.opponents.push(i)}(a,e,t)})),a.index=t,a.opponents.sort(((e,t)=>e-t)),C[l]=a,T=o,A=l)})),C}class f{constructor(e,t){if(this.settings=o(n,function(e){const t={};return"function"!=typeof e.hasAttribute||(e.hasAttribute(r.SETTING_PLACE_COLUMN)&&(t.placeColumn=Number(e.getAttribute(r.SETTING_PLACE_COLUMN))),e.hasAttribute(r.SETTING_STARTING_ROW)&&(t.startingRow=Number(e.getAttribute(r.SETTING_STARTING_ROW))),e.hasAttribute(r.SETTING_ROUNDS_COLUMNS)&&(t.roundsColumns=e.getAttribute(r.SETTING_ROUNDS_COLUMNS)),e.hasAttribute(r.SETTING_REARRANGING)&&(t.rearranging="false"!==e.getAttribute(r.SETTING_REARRANGING)),e.hasAttribute(r.SETTING_HOVERING)&&(t.hovering="false"!==e.getAttribute(r.SETTING_HOVERING))),t}(e),t),e instanceof HTMLPreElement||e instanceof Text){let s=function(e,t){const s=document.createElement("table");if(!e)return s;const l=o(n,t),a=e.replace(/<br[^>]*>/gi,"\n").replace(/<\/?code[^>]*>/gi,"").split(/\r\n|\n/);if(a.length<=2&&!a[0]&&!a[1])return s;const g=i(l.results),h=g.length,u=a.map((e=>e.replace(/([0-9]+)\s(dan|kyu)/i,"$1_$2").split(new RegExp(l.cellSeparator)).filter((e=>e.length>0)))).filter((e=>e.length>0&&0!==e[0].indexOf(";"))),c=u.reduce(((e,t)=>Math.max(e,t.length)),0),p=l.placeColumn||0,m=l.joinNames?-1:0,f=p+1;let d,E=null;return"string"==typeof l.roundsColumns&&(E=l.roundsColumns.split(",").map(Number)),u.forEach(((e,t)=>{const n=document.createElement("tr"),i=e.length;if(i){if(t<l.startingRow||i<c+m){let t=document.createElement("td");t.setAttribute("colspan",c+m),t.textContent=e.join(" "),n.setAttribute(r.PLAYER_PLACEMENT,-1),n.appendChild(t)}else{const t=parseInt(e[p],10);if(isNaN(t)&&!d)e.forEach((e=>{let t=document.createElement("td");t.textContent=e,n.setAttribute(r.PLAYER_PLACEMENT,-1),n.appendChild(t)}));else{n.setAttribute(r.PLAYER_PLACEMENT,d||t);let s=[];l.joinNames&&e.splice(f,2,"".concat(e[f],"  ").concat(e[f+1])),e.forEach(((e,t)=>{let i=document.createElement("td");if(i.textContent=e.replace(/_/," "),!E||E.indexOf(t)>=0)for(let t=0;t<h;t++){let n=e.match(g[t].regexp);if(!n)continue;let l=n[1];s.push(l),i.setAttribute(r.OPPONENT_PLACEMENT,l),i.setAttribute(r.GAME_RESULT,g[t].cls)}n.appendChild(i)})),s.length&&n.setAttribute(r.OPPONENTS,s.join(",")),d?d+=1:d=2}}s.appendChild(n)}})),s.setAttribute(r.RESULT_TABLE,""),s}(e.textContent,t),l=e.parentNode;l.insertBefore(s,e),l.removeChild(e),this.element=s}else this.element=e;this.element.classList&&(this.createPlayersMap(),this.bindEvents(),this.element.classList.add(this.settings.prefixCls+this.settings.tableCls),this.element.setAttribute(r.RESULT_TABLE,""),this.current=null,this.games=[],this.isRearranged=!1,this.isHighlighting=!1)}createPlayersMap(){this.map=m(this.element,this.settings),this.players=[];for(let e in this.map)this.map.hasOwnProperty(e)&&this.players.push(this.map[e])}highlight(e){e||(e={});let t=e.player,n=!0===e.rearrange,i=e.games;const o=this.map[t],a=function(e){let t={};return s.forEach((n=>{t[n]=e.prefixCls+e[n]})),t}(this.settings);this.isRearranged&&this.players.forEach((e=>{const t=e.row.parentNode.children[e.index];t!==e.row&&e.row.parentNode.insertBefore(e.row,t),e.rearranged=!1})),o&&n?(function(e,t){const n=e.row.parentNode;let s=e.row.nextElementSibling;for(let r=0;r<t.length;r++){const i=t[r];i.index<e.index?n.insertBefore(i.row,e.row):(n.insertBefore(i.row,s),s=i.row.nextElementSibling),i.rearranged=!0}}(o,o.opponents.map((e=>this.map[e]))),this.element.classList.add(a.rearrangedCls),this.isRearranged=!0):(this.element.classList.remove(a.rearrangedCls),this.isRearranged=!1);const g=l(this.element.querySelectorAll("."+a.gameCls)),h=this.element.querySelector("."+a.currentCls),u=h?h.getAttribute(r.PLAYER_PLACEMENT):null,c=u?this.map[u]:null,p=(e,t)=>{const n=t?"add":"remove";e.row.classList[n](a.currentCls),e.opponents.forEach((t=>{const s=this.map[t];s&&s.row.classList[n](this.settings.prefixCls+e.opponentsCls[t])}))};if(g.forEach((e=>{e.classList.remove(a.gameCls)})),c&&c!==o&&p(c,!1),o&&o!==c&&p(o,!0),this.games.length=0,o){if("number"==typeof i&&(i=[i]),i&&"number"==typeof i.length){for(const t of o.games)if(i.includes(t.opponentPlace)&&(!e.column||e.column===t.index)){const e=N(this.map[t.opponentPlace],t);if(!e)continue;t.cell.classList.add(a.gameCls),e.cell.classList.add(a.gameCls),this.games.push(t.opponentPlace)}}else if(this.isRearranged)for(const e of o.games){const t=N(this.map[e.opponentPlace],e);t&&(t.cell.classList.add(a.gameCls),this.games.push(e.opponentPlace))}this.games.sort(),this.current=t,this.isHighlighting=!0}else this.current=null,this.isHighlighting=!1}configure(e){this.highlight(null),this.element.classList.remove(this.settings.prefixCls+this.settings.tableCls),this.settings=o(this.settings,e),this.createPlayersMap(),this.element.classList.add(this.settings.prefixCls+this.settings.tableCls)}bindEvents(){let e=!1,t=!1;this.element.addEventListener("touchstart",(()=>{e=!1})),this.element.addEventListener("touchmove",(()=>{e=!0})),this.element.addEventListener("touchend",(n=>{if(e||!1===this.settings.rearranging&&!1===this.settings.hovering)return;let{target:s,player:r,games:i}=E(n.target,this.element);if(!r)return;let l,o=!1;this.current===r?(this.settings.rearranging&&this.settings.hovering||(r=null),o=!this.isRearranged):!this.isRearranged&&this.settings.hovering||(o=!0),o&&(l=s.getBoundingClientRect().top),this.highlight({player:r,games:i,rearrange:o}),l&&d(s,l),t=!0})),this.element.addEventListener("click",(e=>{if(t)return void(t=!1);if(!1===this.settings.rearranging)return;let n,{target:s,player:r,games:i}=E(e.target,this.element),l=!1;r&&(!this.isRearranged||this.map[r]&&this.map[r].rearranged?l=!0:this.settings.hovering||(r=null),n=s.getBoundingClientRect().top,this.highlight({player:r,games:i,rearrange:l}),n&&d(s,n))})),this.element.addEventListener("mouseover",(e=>{if(!1===this.settings.hovering)return;let{player:t,games:n,column:s}=E(e.target,this.element),r=this.isRearranged;if(t){if(this.isRearranged){if((!n||t!==this.current)&&this.games.length===this.map[this.current].opponents.length)return;t!==this.current&&(t=this.current,n=null)}this.highlight({player:t,rearrange:r,games:n,column:s})}}),!1),this.element.addEventListener("mouseout",(e=>{if(!1===this.settings.hovering)return;let t=e.relatedTarget;for(;t&&t!==document&&t!==this.element;)t=t.parentNode;t!==this.element&&(this.isRearranged&&this.games.length!==this.map[this.current].opponents.length?this.highlight({player:this.current,rearrange:!0}):this.isRearranged||this.highlight(null))}),!1)}clearInlineStyles(){this.players.forEach((e=>{l(e.row.childNodes).filter((e=>e.nodeType===Node.ELEMENT_NODE)).forEach((e=>e.removeAttribute("style")))}))}}function d(e,t){let n=e.getBoundingClientRect().top-t;Math.abs(n)>10&&window.scrollBy(0,n)}function E(e,t){const n={player:null,games:null,target:null};for(;e&&e!==document&&e!==t;){if(e.highlighterGame)return{player:e.highlighterGame.player,games:e.highlighterGame.opponent,target:e.highlighterGame.row,column:e.highlighterGame.column};let t=e.getAttribute(r.OPPONENT_PLACEMENT),s=e.getAttribute(r.PLAYER_PLACEMENT);if(t&&(n.games=Number(t)),s){n.player=Number(s);break}e=e.parentNode}return n.target=e,n}function N(e,t){let n,s=null;for(const r of e.games){const e=Math.abs(t.index-r.index);(!s||e<n)&&(s=r,n=e)}return s}function C(e){return{get:e,enumerable:!0,configurable:!1}}f.DEFAULT_SETTINGS=n;const T=function e(t,n){if(!t)return;if(!(this instanceof e))return new e(t,n);const s=new f(t,n);this.highlight=(e,t,n)=>{"object"==typeof e?s.highlight(e):("boolean"==typeof t&&(n=t,t=null),s.highlight({player:e,rearrange:n,games:t}))},this.configure=e=>{s.configure(e)},this.opponents=e=>{const t=s.map[e];return t?t.opponents.slice():[]},this.clearInlineStyles=()=>{s.clearInlineStyles()},Object.defineProperties(this,{element:C((()=>s.element)),isHighlighting:C((()=>s.isHighlighting)),isRearranged:C((()=>s.isRearranged)),player:C((()=>s.current||null)),players:C((()=>s.players.length)),games:C((()=>s.games)),configuration:C((()=>{const e=s.settings.results,t={};for(let n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return{startingRow:s.settings.startingRow,placeColumn:s.settings.placeColumn,roundsColumns:s.settings.roundsColumns,prefixCls:s.settings.prefixCls,rearrangedCls:s.settings.rearrangedCls,tableCls:s.settings.tableCls,gameCls:s.settings.gameCls,currentCls:s.settings.currentCls,rowTags:s.settings.rowTags,cellTags:s.settings.cellTags,cellSeparator:s.settings.cellSeparator,joinNames:s.settings.joinNames,ignoreOutOfBoundsRows:s.settings.ignoreOutOfBoundsRows,checkColumnsForResults:s.settings.checkColumnsForResults,results:t}})),rearranging:{set:e=>{!e&&s.isRearranged&&s.highlight(null),s.settings.rearranging=!!e},get:()=>s.settings.rearranging,configurable:!1,enumerable:!0},hovering:{set:e=>s.settings.hovering=!!e,get:()=>s.settings.hovering,configurable:!1,enumerable:!0}}),s.element.goResultsHighlighter=this};return t.default})()));